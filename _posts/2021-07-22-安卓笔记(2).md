---
layout: post
title: 安卓笔记(二)：Activity、
date: 2021-07-22
tags: 安卓
---

## 四、Activity相关

### 1.Activity的启动流程是怎样的？
**题目剖析**    
* 与AMS如何交互
* Activity的参数和结果如何传递
* Activity如何实例化
* Activity生命周期如何流转
* Activity的窗口如何展示
* Activity转场动画的实现机制    

#### Activity跨进程启动
可以参考这位大佬的[系列文章](http://liuwangshu.cn/framework/applicationprocess/1.html)

**跨进程**    
请求进程A（例如launcher进程，启动某一个APP）  --->>   通过AMP(AMS的代理)与AMS进行Binder通信  --->>  AMS解析Activity信息（主要就是Manifest文件里配置的信息）、处理启动参数、启动目标进程（通过Zygote）、绑定新进程  --->>   system_server通过调用ATP(目标进程B的ApplicationThread的代理)的scheduleLaunchActivity启动Activity在目标进程中（Binder通信）  --->>  ApplicationThread、ActivityThread、Activity生命周期     

Activity跨进程启动流程图        
![Activity跨进程启动流程图](/images/Activity跨进程启动流程图.png)

#### Activity进程内启动
**进程内**   
进程A  --->>  AMP  --->>  system_server进程  --->>  AMS解析信息，处理启动参数  --->>  ATP scheduleLaunchActivity --->>   进程A ApplicationThread、ActivityThread、Activity生命周期    

Activity进程内启动流程图    
![Activity进程内启动流程图](/images/Activity进程内启动.png)
两个小红圈的地方，就是可以进行插件化hook的地方

#### Activity的参数传递
跨进程通过Binder传递， Binder缓冲区 ①大小受<font color=red>缓冲区大小</font>限制 ②数据必须可以<font color=red>序列化</font>。    
两个Activity在同一进程的话，传递Key，通过贡献model，来存取数据。    
* Model可存内存或持久化
* 跨进程需实现进程通信机制

#### Activity实例化

```Java
Instrumentation
public Activity newActivity(ClassLoader cl, String className,
            Intent intent)
            throws InstantiationException, IllegalAccessException,
            ClassNotFoundException {
        String pkg = intent != null && intent.getComponent() != null
                ? intent.getComponent().getPackageName() : null;
        return getFactory(pkg).instantiateActivity(cl, className, intent);
    }
AppComponentFactory
public @NonNull Activity instantiateActivity(@NonNull ClassLoader cl, @NonNull String className,
            @Nullable Intent intent)
            throws InstantiationException, IllegalAccessException, ClassNotFoundException {
        return (Activity) cl.loadClass(className).newInstance();
    }
```

Activity不能添加构造方法，Fragment不能添加有参数的构造方法，因为在activity状态保存和恢复的时候，重新创建。    

#### Activity的窗口如何展示
![Activity的窗口如何展示](/images/Activity的窗口如何展示.png)

#### Activity转场动画的实现机制
安卓5.0之后加入的 类似keynote里神奇动画的效果。
**调用过程**    
![1](/images/Activity转场动画的实现机制1.png)
![2](/images/Activity转场动画的实现机制2.png)

### 2.如何跨App启动Activity？有哪些注意事项？
**题目剖析**    
--跨App    
--注意事项   

#### 跨App启动Activity有哪些方式？
* 共享uid的APP，manifest根节点android:sharedUserId="com.XXXX"，流量计算也是共享的（linux流量计算），方式：        intent.setComponent(new ComponentName("pkgname_b", "activity_b"));
* 使用exported， 在manifest activity节点，例如微信登陆。启动方式与上一个类似。
* 使用intentFilter action节点

#### 为允许外部启动的Activity加权限
![为允许外部启动的Activity加权限](/images/为允许外部启动的Activity加权限.png)
**注意：这种情况APP_B 一定要在APP_A之前安装。**

#### 拒绝服务漏洞
**原因是 Activity 从bundle中getExtra拿数据时，一定会将数据反序列化，这个过程中如果有未知的类，就会报异常。**     
**解决办法很简单，读传递的数据时，加一下try-catch**    



















------------------------
